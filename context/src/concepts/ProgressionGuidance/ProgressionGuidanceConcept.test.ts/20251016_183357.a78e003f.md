---
timestamp: 'Thu Oct 16 2025 18:33:57 GMT-0400 (Eastern Daylight Time)'
content_id: a78e003fa7cc3c9451b4ef72314dc1d135dcb5ccae4d14b87d5d87cc8b2e2083
---

# file: src/concepts/ProgressionGuidance/ProgressionGuidanceConcept.test.ts

```typescript
import { assertEquals, assertRejects } from "jsr:@std/assert";
import { testDb } from "@utils/database.ts";
import { ID } from "@utils/types.ts";
import ProgressionGuidanceConcept, { WorkoutSummary, LLM } from "./ProgressionGuidanceConcept.ts";

const testUser = "user:testUser123" as ID;
const benchPress = "Bench Press";

// Mock LLM for testing (no API calls needed)
class MockLLM implements LLM {
  constructor(private response: any) {}
  
  async executeLLM(_prompt: string): Promise<string> {
    return JSON.stringify(this.response);
  }
}

// Helper to create workout summary
function createSummary(sets: Array<{ weight: number; reps: number; daysAgo: number }>): WorkoutSummary {
  const recentSets = sets.map(s => {
    const date = new Date();
    date.setDate(date.getDate() - s.daysAgo);
    return { weight: s.weight, reps: s.reps, date };
  });
  
  const sessionDates = new Set(recentSets.map(s => s.date.toDateString()));
  
  return {
    recentSets,
    sessionCount: sessionDates.size,
    lastWorkoutDate: recentSets[recentSets.length - 1].date,
  };
}

// Test 1: Operational Principle
Deno.test("Principle: Generate recommendation, user accepts it later", async () => {
  const [db, client] = await testDb();
  const guidance = new ProgressionGuidanceConcept(db);

  console.log("ðŸ“ Testing operational principle...");
  
  // Create plateau scenario
  const summary = createSummary([
    { weight: 185, reps: 5, daysAgo: 21 },
    { weight: 185, reps: 5, daysAgo: 14 },
    { weight: 185, reps: 5, daysAgo: 7 },
    { weight: 185, reps: 4, daysAgo: 0 },
  ]);

  const mockLLM = new MockLLM({
    suggestedWeight: 175,
    suggestedReps: 5,
    plateauDetected: true,
    reasoning: "You've been stuck at 185lbs for 4 sessions. Time for a deload.",
    interventionStrategy: "deload"
  });

  // Generate recommendation
  await guidance.generateRecommendationLLM(testUser, benchPress, summary, mockLLM);
  
  // Get recommendation
  const rec = await guidance.getRecommendation(testUser, benchPress);
  assertEquals(rec?.status, "pending");
  assertEquals(rec?.suggestedWeight, 175);
  
  // Accept it
  const accepted = await guidance.acceptRecommendation(testUser, benchPress, rec!.createdAt);
  assertEquals(accepted.suggestedWeight, 175);
  assertEquals(accepted.suggestedReps, 5);
  
  // Verify status changed
  const updated = await guidance.getRecommendation(testUser, benchPress);
  assertEquals(updated?.status, "accepted");
  
  console.log("âœ… Generated, retrieved, and accepted recommendation\n");
  
  await client.close();
});

// Test 2: Dismiss recommendation
Deno.test("Action: dismissRecommendation updates status", async () => {
  const [db, client] = await testDb();
  const guidance = new ProgressionGuidanceConcept(db);

  console.log("ðŸ“ Testing dismissRecommendation...");
  
  const summary = createSummary([
    { weight: 225, reps: 5, daysAgo: 14 },
    { weight: 230, reps: 5, daysAgo: 7 },
    { weight: 235, reps: 5, daysAgo: 0 },
  ]);

  const mockLLM = new MockLLM({
    suggestedWeight: 240,
    suggestedReps: 5,
    plateauDetected: false,
    reasoning: "You're progressing well. Continue with small increases.",
    interventionStrategy: "progress"
  });

  await guidance.generateRecommendationLLM(testUser, "Squat", summary, mockLLM);
  const rec = await guidance.getRecommendation(testUser, "Squat");
  
  await guidance.dismissRecommendation(testUser, "Squat", rec!.createdAt);
  
  const dismissed = await guidance.getRecommendation(testUser, "Squat");
  assertEquals(dismissed?.status, "dismissed");
  
  console.log("âœ… Successfully dismissed recommendation\n");
  
  await client.close();
});

// Test 3: Recommendation history
Deno.test("Action: getRecommendationHistory returns all recommendations", async () => {
  const [db, client] = await testDb();
  const guidance = new ProgressionGuidanceConcept(db);

  console.log("ðŸ“ Testing recommendation history...");
  
  const summary = createSummary([
    { weight: 185, reps: 5, daysAgo: 14 }, 
    { weight: 185, reps: 5, daysAgo: 7 },
    { weight: 185, reps: 5, daysAgo: 0 },
  ]);

  const mockLLM = new MockLLM({
    suggestedWeight: 190,
    suggestedReps: 5,
    plateauDetected: false,
    reasoning: "Progress to 190lbs",
    interventionStrategy: "progress"
  });

  // Generate 3 recommendations
  await guidance.generateRecommendationLLM(testUser, "Deadlift", summary, mockLLM);
  await guidance.generateRecommendationLLM(testUser, "Deadlift", summary, mockLLM);
  await guidance.generateRecommendationLLM(testUser, "Deadlift", summary, mockLLM);
  
  const history = await guidance.getRecommendationHistory(testUser, "Deadlift");
  assertEquals(history.length, 3);
  
  console.log(`âœ… Retrieved ${history.length} recommendations from history\n`);
  
  await client.close();
});

// Test 4: Insufficient data validation
Deno.test("Action: generateRecommendationLLM requires 3+ sets", async () => {
  const [db, client] = await testDb();
  const guidance = new ProgressionGuidanceConcept(db);

  console.log("ðŸ“ Testing insufficient data validation...");
  
  const summary = createSummary([
    { weight: 185, reps: 5, daysAgo: 7 },
    { weight: 185, reps: 5, daysAgo: 0 },
  ]);

  const mockLLM = new MockLLM({
    suggestedWeight: 190,
    suggestedReps: 5,
    plateauDetected: false,
    reasoning: "Test",
    interventionStrategy: "progress"
  });

  await assertRejects(
    async () => await guidance.generateRecommendationLLM(testUser, benchPress, summary, mockLLM),
    Error,
    "Need at least 3 recent sets"
  );
  
  console.log("âœ… Correctly rejected insufficient data\n");
  
  await client.close();
});

// Test 5: Validator - extreme weight change
Deno.test("Validator: Rejects extreme weight suggestions (>20% change)", async () => {
  const [db, client] = await testDb();
  const guidance = new ProgressionGuidanceConcept(db);

  console.log("ðŸ“ Testing weight change validator...");
  
  const summary = createSummary([
    { weight: 185, reps: 5, daysAgo: 14 },
    { weight: 185, reps: 5, daysAgo: 7 },
    { weight: 185, reps: 5, daysAgo: 0 },
  ]);

  const mockLLM = new MockLLM({
    suggestedWeight: 250, // 35% increase - should fail
    suggestedReps: 5,
    plateauDetected: false,
    reasoning: "Test",
    interventionStrategy: "progress"
  });

  await assertRejects(
    async () => await guidance.generateRecommendationLLM(testUser, benchPress, summary, mockLLM),
    Error,
    "Max allowed: 20%"
  );
  
  console.log("âœ… Validator caught extreme weight hallucination\n");
  
  await client.close();
});

// Test 6: Validator - invalid rep range
Deno.test("Validator: Rejects invalid rep ranges", async () => {
  const [db, client] = await testDb();
  const guidance = new ProgressionGuidanceConcept(db);

  console.log("ðŸ“ Testing rep range validator...");
  
  const summary = createSummary([
    { weight: 185, reps: 5, daysAgo: 14 }, 
    { weight: 185, reps: 5, daysAgo: 7 },
    { weight: 185, reps: 5, daysAgo: 0 },
  ]);

  const mockLLM = new MockLLM({
    suggestedWeight: 185,
    suggestedReps: 50, // Invalid
    plateauDetected: false,
    reasoning: "Test",
    interventionStrategy: "progress"
  });

  await assertRejects(
    async () => await guidance.generateRecommendationLLM(testUser, benchPress, summary, mockLLM),
    Error,
    "outside reasonable range"
  );
  
  console.log("âœ… Validator caught invalid rep range\n");
  
  await client.close();
});

// Test 7: Validator - plateau-strategy contradiction
Deno.test("Validator: Ensures plateau + progress don't coexist", async () => {
  const [db, client] = await testDb();
  const guidance = new ProgressionGuidanceConcept(db);

  console.log("ðŸ“ Testing plateau-strategy validator...");
  
  const summary = createSummary([
    { weight: 185, reps: 5, daysAgo: 14 },
    { weight: 185, reps: 5, daysAgo: 7 },
    { weight: 185, reps: 5, daysAgo: 0 },
  ]);

  const mockLLM = new MockLLM({
    suggestedWeight: 190,
    suggestedReps: 5,
    plateauDetected: true, // Says plateau...
    reasoning: "Test",
    interventionStrategy: "progress" // ...but suggests progress (contradiction)
  });

  await assertRejects(
    async () => await guidance.generateRecommendationLLM(testUser, benchPress, summary, mockLLM),
    Error,
    "not deload/maintain/variation"
  );
  
  console.log("âœ… Validator caught plateau-strategy contradiction\n");
  
  await client.close();
});
```
