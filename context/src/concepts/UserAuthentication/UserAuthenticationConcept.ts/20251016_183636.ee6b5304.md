---
timestamp: 'Thu Oct 16 2025 18:36:36 GMT-0400 (Eastern Daylight Time)'
content_id: ee6b5304201f3f0d647ae89571240d5848929fc72c16305bd41c42088d99285e
---

# file: src/concepts/UserAuthentication/UserAuthenticationConcept.ts

```typescript
import { Collection, Db } from "npm:mongodb";
import { ID } from "@utils/types.ts";
import { freshID } from "@utils/database.ts";
import * as bcrypt from "https://deno.land/x/bcrypt@v0.4.1/mod.ts";

/**
 * User document
 */
interface UserDoc {
  _id: ID;
  username: string;
  passwordHash: string;
}

/**
 * Session document
 */
interface SessionDoc {
  _id: ID;
  user: ID;
  token: string;
}

export default class UserAuthenticationConcept {
  private readonly users: Collection<UserDoc>;
  private readonly sessions: Collection<SessionDoc>;

  constructor(private readonly db: Db) {
    this.users = db.collection("users");
    this.sessions = db.collection("sessions");
  }

  /**
   * Register new user
   */
  async register(username: string, password: string): Promise<ID> {
    const existing = await this.users.findOne({ username });
    if (existing) {
      throw new Error("Username already taken");
    }

    if (password.length < 6) {
      throw new Error("Password must be at least 6 characters");
    }

    const passwordHash = await bcrypt.hash(password);
    const userId = freshID();

    await this.users.insertOne({
      _id: userId,
      username,
      passwordHash,
    });

    return userId;
  }


  /**
   * Login - creates session and returns token
   */
  async login(username: string, password: string): Promise<string> {
    const user = await this.users.findOne({ username });
    if (!user) {
      throw new Error("Invalid credentials");
    }

    const valid = await bcrypt.compare(password, user.passwordHash);
    if (!valid) {
      throw new Error("Invalid credentials");
    }

    const token = freshID();
    await this.sessions.insertOne({
      _id: freshID(),
      user: user._id,
      token,
    });

    return token;
  }

  /**
   * Authenticate token - returns user ID
   */
  async authenticate(token: string): Promise<ID> {
    const session = await this.sessions.findOne({ token });
    if (!session) {
      throw new Error("Invalid or expired session");
    }

    return session.user;
  }

  /**
   * Logout - removes session
   */
  async logout(token: string): Promise<void> {
    const result = await this.sessions.deleteOne({ token });
    if (result.deletedCount === 0) {
      throw new Error("Session not found");
    }
  }

  /**
   * Delete account - removes user and all sessions
   */
  async deleteAccount(userId: ID): Promise<void> {
    const user = await this.users.findOne({ _id: userId });
    if (!user) {
      throw new Error("User not found");
    }

    await this.users.deleteOne({ _id: userId });
    await this.sessions.deleteMany({ user: userId });
  }
}
```
